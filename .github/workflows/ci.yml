name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: macos-26  # macOS 26 with Xcode 16 and iOS 26 SDK preinstalled
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.9"
      
      - name: Install SwiftFormat
        run: brew install swiftformat
      
      - name: Run SwiftFormat check
        run: swiftformat --lint ios-app/FareLens
      
      - name: Run iOS 26 pattern validation
        run: |
          chmod +x scripts/check-ios26-patterns.sh
          ./scripts/check-ios26-patterns.sh
      
      - name: Check for print statements
        run: |
          PRINT_STATEMENTS=$(find ios-app/FareLens -name "*.swift" -type f ! -name "*Tests.swift" \
            -exec grep -l 'print(' {} + 2>/dev/null || true)

          if [ -n "$PRINT_STATEMENTS" ]; then
            echo "❌ Found print statements (use OSLog instead)"
            echo "$PRINT_STATEMENTS"
            exit 1
          fi

      - name: Check for force unwraps
        run: |
          # Find files with potential force unwraps (variable!)
          # Excludes: string literals, comments, != operators, array syntax [Int]!
          FORCE_UNWRAPS=$(find ios-app/FareLens -name "*.swift" -type f ! -name "*Tests.swift" -print0 | \
            xargs -0 grep -n "[a-zA-Z0-9_)]!" | \
            grep -v "//" | \
            grep -v "\".*!.*\"" | \
            grep -v "!=" | \
            grep -v "\[.*\]!" || true)

          if [ -n "$FORCE_UNWRAPS" ]; then
            echo "❌ Found potential force unwraps:"
            echo "$FORCE_UNWRAPS"
            echo ""
            echo "Please use safe optional handling (if let, guard let, or ?? operator)"
            exit 1
          fi

  tests:
    name: Run Tests
    runs-on: macos-26  # macOS 26 with Xcode 16 and iOS 26 SDK preinstalled
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Secrets for CI
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY: ${{ secrets.SUPABASE_PUBLISHABLE_KEY }}
          CLOUDFLARE_WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}
        run: |
          # Validate secrets are set (fail early if missing)
          if [ -z "${SUPABASE_URL}" ] || [ -z "${SUPABASE_PUBLISHABLE_KEY}" ] || [ -z "${CLOUDFLARE_WORKER_URL}" ]; then
            echo "❌ ERROR: Required secrets not configured in GitHub repository settings"
            echo "Missing secrets:"
            [ -z "${SUPABASE_URL}" ] && echo "  - SUPABASE_URL"
            [ -z "${SUPABASE_PUBLISHABLE_KEY}" ] && echo "  - SUPABASE_PUBLISHABLE_KEY"
            [ -z "${CLOUDFLARE_WORKER_URL}" ] && echo "  - CLOUDFLARE_WORKER_URL"
            echo ""
            echo "To fix: Go to Settings → Secrets and variables → Actions → New repository secret"
            echo "Add the three secrets listed above with your Supabase/Cloudflare credentials"
            exit 1
          fi

          # Create Secrets.xcconfig from validated GitHub Secrets
          # Using echo instead of heredoc to avoid shell expansion issues
          echo "// FareLens Secrets Configuration - CI/CD" > ios-app/FareLens/Config/Secrets.xcconfig
          echo "// Auto-generated from GitHub Secrets" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "// Supabase Configuration" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "SUPABASE_URL = ${SUPABASE_URL}" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "SUPABASE_PUBLISHABLE_KEY = ${SUPABASE_PUBLISHABLE_KEY}" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "// Cloudflare Workers API" >> ios-app/FareLens/Config/Secrets.xcconfig
          echo "CLOUDFLARE_WORKER_URL = ${CLOUDFLARE_WORKER_URL}" >> ios-app/FareLens/Config/Secrets.xcconfig

          echo "✅ Created Secrets.xcconfig from GitHub Secrets"

      - name: Check for Xcode project
        id: check_project
        run: |
          if [ -f "ios-app/FareLens.xcodeproj/project.pbxproj" ]; then
            echo "has_project=true" >> $GITHUB_OUTPUT
          else
            echo "has_project=false" >> $GITHUB_OUTPUT
            echo "⚠️ No Xcode project found - skipping tests"
          fi

      - name: Setup Xcode
        if: steps.check_project.outputs.has_project == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0.1"  # Pin to Xcode 26.0.1 (GM) for consistency

      - name: Run tests
        if: steps.check_project.outputs.has_project == 'true'
        run: |
          cd ios-app
          xcodebuild test \
            -scheme FareLens \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro Max' \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

